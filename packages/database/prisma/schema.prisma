generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

model SignUpAttempt {
    attempts             Int      @default(0)
    firstName            String
    lastName             String?
    email                String
    passwordHash         String
    token                String   @unique
    verificationCodeHash String
    createdAt            DateTime @default(now())
    expiresAt            DateTime
}

model User {
    id              String    @id
    firstName       String
    lastName        String?
    email           String    @unique
    passwordHash    String
    verified        Boolean   @default(false)
    passwordEnabled Boolean
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt
    lastSignInAt    DateTime?

    sessions             Session[]
    workspaceMemberships WorkspaceMembership[]
    workspaceActivities  WorkspaceActivity[]
    boards               Board[]
    tasks                Task[]
    comments             Comment[]
    notifications        Notification[]
}

model Session {
    id           String   @id
    userAgent    String   @default("unknown")
    ipAddress    String   @default("unknown")
    userId       String
    expiresAt    DateTime
    createdAt    DateTime @default(now())
    lastActiveAt DateTime @default(now())
    updatedAt    DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model Workspace {
    id         String  @id
    strictMode Boolean @default(false)
    name       String

    memberships WorkspaceMembership[]
    activities  WorkspaceActivity[]
    invitations WorkspaceInvitation[]
    boards      Board[]
}

enum WorkspaceMemberRole {
    ADMIN
    GUEST
    MANAGER
    MEMBER
}

model WorkspaceMembership {
    userId      String
    workspaceId String
    role        WorkspaceMemberRole
    createdAt   DateTime            @default(now())
    updatedAt   DateTime            @updatedAt

    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@unique([userId, workspaceId])
}

model WorkspaceActivity {
    id          String   @id
    actorId     String
    workspaceId String
    message     String
    createdAt   DateTime @default(now())

    actor     User      @relation(fields: [actorId], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@index([workspaceId])
    @@index([actorId])
    @@index([workspaceId, actorId])
}

model WorkspaceInvitation {
    workspaceId String
    email       String
    role        WorkspaceMemberRole
    token       String              @unique
    createdAt   DateTime            @default(now())
    updatedAt   DateTime            @updatedAt
    expiresAt   DateTime

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@unique([email, workspaceId])
}

model Board {
    id          String   @id
    creatorId   String
    workspaceId String
    title       String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    lists List[]

    creator   User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@index([workspaceId])
    @@index([creatorId])
    @@index([workspaceId, creatorId])
}

model List {
    id        String   @id
    position  Float
    title     String
    boardId   String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    tasks Task[]

    board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

    @@index([boardId])
}

model Task {
    id         String    @id
    listId     String
    assigneeId String?
    title      String
    position   Float
    dueDate    DateTime?
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt

    comments Comment[]

    assignee User? @relation(fields: [assigneeId], references: [id], onDelete: Cascade)
    list     List  @relation(fields: [listId], references: [id], onDelete: Cascade)

    @@index([listId])
}

model Comment {
    id        String   @id
    taskId    String
    userId    String
    text      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([taskId])
}

model Notification {
    id        String   @id
    userId    String
    text      String
    read      Boolean  @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}
